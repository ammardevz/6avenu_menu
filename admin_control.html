<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <!-- Skeleton Loader -->
    <div class="skeleton-loader" id="skeletonLoader">
        <div class="skeleton-header"></div>
        <div class="skeleton-section starter"></div>
        <div class="skeleton-section quick-nav"></div>
    </div>

    <section class="freeze hidden">
        <div class="editor splitv">
            <i class="fas fa-times fa-2x" style="text-align: right; cursor: pointer;" id="editorCloseBtn"></i>
            <div class="splitv innier-editor">
                <img src="" alt="Product Image Preview" id="editorImage">
                <div class="splitv" style="gap: 20px;">
                    <input type="file" id="productImageInput" accept="image/*">
                    <input type="text" class="text-input" id="productNameInput" placeholder="Product Name">
                    <input type="number" class="text-input" id="productPriceInput" placeholder="Price">
                    <select id="productCategoryInput" class="tag-input">
                        <option value="">Select Category</option>
                        <!-- Categories will be dynamically added here -->
                    </select>
                </div>
            </div>
            <button id="deleteProductButton" class="hidden cta-button"
                style="border: none; margin: 10px 0px;">Delete</button>
            <button class="cta-button" style="border: none;" id="saveProductButton">Save</button>
        </div>
    </section>

    <header>
        <div class="logo" style="justify-content: space-between;">
            <a href="index.html">
                <h1 style="color: red; opacity: 1;">AVENUE</h1>
                <h5 style="color: red; opacity: 1;">ADMIN MODE</h5>
            </a>
            <button id="logout-button">LOGOUT</button>
        </div>
    </header>

    <main class="admin-main">
        <section class="stats-section">
            <!-- Daily Sales Chart -->
            <div class="chart-container">
                <h2>Daily Sales (Last 7 Days)</h2>
                <canvas id="dailySalesChart"></canvas>
            </div>

            <!-- Product Sales Distribution -->
            <div class="chart-container">
                <h2>Product Sales Distribution</h2>
                <canvas id="productChart"></canvas>
            </div>
        </section>

        <h2>Products</h2>

        <button id="createNewProductButton" class="cta-button" style="margin-bottom: 20px; border: none;">Create New
            Product</button>

        <section class="product-editor">
            <!-- Products will be dynamically added here -->
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="admin.js"></script>
    <script src="auth_check.js"></script>
    <script>
        // Ensure fetchWithTimeout and logout are available globally
        function fetchWithTimeout(url, options = {}, timeout = 8000) {
            const defaultOptions = {
                credentials: 'include',
                ...options
            };

            return Promise.race([
                fetch(url, defaultOptions),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Request timed out')), timeout)
                )
            ]);
        }

        async function logout() {
            try {
                const response = await fetch('https://coffee-api-bold-moon-8315.fly.dev/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    console.log('Successfully logged out');
                    window.location.href = '/login.html'; // Redirect to login page
                } else {
                    console.error('Failed to log out', response.status);
                    alert('Failed to log out. Please try again.');
                }
            } catch (error) {
                console.error('Error during logout:', error);
                alert('An error occurred while logging out. Please try again.');
            }
        }

        // Add event listener to logout button
        document.getElementById('logout-button').addEventListener('click', logout);

        // Process daily sales data
        function processDailySales(ordersData, orderProductsData, productsData) {
            const dailySales = {};
            const today = new Date();
            const lastWeekDates = Array.from({ length: 7 }, (_, i) => {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                return date.toISOString().split('T')[0]; // YYYY-MM-DD format
            });

            lastWeekDates.forEach(date => {
                dailySales[date] = 0;
            });

            ordersData.forEach(order => {
                const date = order.created_at.split('T')[0];
                if (dailySales[date] !== undefined) {
                    const orderProducts = orderProductsData.filter(op => op.order_id === order.id);
                    orderProducts.forEach(op => {
                        dailySales[date] += op.quantity * parseFloat(op.price_at_time);
                    });
                }
            });

            const labels = lastWeekDates.reverse();
            const data = labels.map(date => dailySales[date]);

            return {
                labels: labels,
                datasets: [{
                    label: 'Daily Sales',
                    data: data,
                    fill: false,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    tension: 0.1
                }]
            };
        }

        // Process product sales data for pie chart
        function processProductSales(productsData, orderProductsData) {
            const productSales = {};
            const productUnitsSold = {};

            productsData.forEach(product => {
                productSales[product.name] = 0;
                productUnitsSold[product.name] = 0;
            });

            orderProductsData.forEach(op => {
                const product = productsData.find(p => p.id === op.product_id);
                if (product) {
                    productSales[product.name] += op.quantity * parseFloat(op.price_at_time);
                    productUnitsSold[product.name] += op.quantity;
                }
            });

            const labels = Object.keys(productSales);
            const revenueData = Object.values(productSales);
            const unitsData = labels.map(label => productUnitsSold[label]);

            return {
                labels: labels,
                revenueData: revenueData,
                unitsData: unitsData,
                datasets: [{
                    label: 'Product Sales',
                    data: revenueData,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)'
                    ],
                    borderWidth: 1
                }]
            };
        }

        function updateDailySalesChart(dailySales) {
            const ctx = document.getElementById('dailySalesChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: dailySales,
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Revenue'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateProductChart(productSales) {
            const ctx = document.getElementById('productChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: productSales.labels,
                    datasets: [{
                        label: 'Product Sales',
                        data: productSales.revenueData,
                        backgroundColor: productSales.datasets[0].backgroundColor,
                        borderColor: productSales.datasets[0].borderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    const idx = tooltipItem.dataIndex;
                                    const units = productSales.unitsData[idx];
                                    const revenue = productSales.revenueData[idx];
                                    return `${tooltipItem.label}: ${units} units ($${revenue.toFixed(2)})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fetch data and update charts on page load
        async function fetchDataAndUpdateCharts() {
            try {
                const [ordersResponse, orderProductsResponse, productsResponse] = await Promise.all([
                    fetchWithTimeout('https://coffee-api-bold-moon-8315.fly.dev/orders'),
                    fetchWithTimeout('https://coffee-api-bold-moon-8315.fly.dev/order_products'),
                    fetchWithTimeout('https://coffee-api-bold-moon-8315.fly.dev/products')
                ]);
                if (!ordersResponse.ok || !orderProductsResponse.ok || !productsResponse.ok) {
                    throw new Error('One or more requests failed.');
                }
                const [ordersData, orderProductsData, productsData] = await Promise.all([
                    ordersResponse.json(),
                    orderProductsResponse.json(),
                    productsResponse.json()
                ]);

                const dailySales = processDailySales(ordersData, orderProductsData, productsData);
                updateDailySalesChart(dailySales);

                const productSales = processProductSales(productsData, orderProductsData);
                updateProductChart(productSales);

                // Hide skeleton loader
                document.getElementById('skeletonLoader').style.display = 'none';

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('skeletonLoader').style.display = 'none'; // Hide loader if error occurs
            }
        }

        // Call fetchDataAndUpdateCharts when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', fetchDataAndUpdateCharts);
    </script>
</body>

</html>